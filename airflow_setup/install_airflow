# airflow_setup/install_airflow.sh - VERSION CORRIGÃ‰E
#!/bin/bash
echo "ğŸ”„ Installation et configuration Airflow pour TechShop 2025"

# DÃ©tecter le bon chemin vers l'environnement virtuel
if [ -d "../venv3" ]; then
    VENV_PATH="../venv3"
elif [ -d "/opt/app/bigquery-projects/venv3" ]; then
    VENV_PATH="/opt/app/bigquery-projects/venv3"
elif [ -d "../../venv3" ]; then
    VENV_PATH="../../venv3"
else
    echo "âŒ Environnement virtuel non trouvÃ© !"
    echo "Chemins recherchÃ©s :"
    echo "  - ../venv3"
    echo "  - /opt/app/bigquery-projects/venv3" 
    echo "  - ../../venv3"
    echo ""
    echo "Veuillez indiquer le chemin correct vers votre environnement virtuel :"
    read -p "Chemin vers venv3 : " VENV_PATH
fi

echo "ğŸ“‚ Utilisation de l'environnement virtuel : $VENV_PATH"

# Configuration des variables
export AIRFLOW_HOME=~/airflow
export AIRFLOW_VERSION=2.8.0
export PYTHON_VERSION="$(python --version | cut -d " " -f 2 | cut -d "." -f 1-2)"
export CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"

# Activer l'environnement virtuel
echo "ï¿½ï¿½ Activation de l'environnement virtuel..."
source $VENV_PATH/bin/activate

# VÃ©rifier l'activation
if [ $? -ne 0 ]; then
    echo "âŒ Impossible d'activer l'environnement virtuel"
    exit 1
fi

echo "âœ… Environnement virtuel activÃ©"

# Installer Airflow
echo "ğŸ“¦ Installation d'Airflow..."
pip install "apache-airflow==${AIRFLOW_VERSION}" --constraint "${CONSTRAINT_URL}"
pip install apache-airflow-providers-google

# VÃ©rifier l'installation
if ! command -v airflow &> /dev/null; then
    echo "âŒ Airflow non installÃ© correctement"
    exit 1
fi

echo "âœ… Airflow installÃ© avec succÃ¨s"

# Initialiser la base de donnÃ©es
echo "ğŸ—„ï¸ Initialisation de la base de donnÃ©es Airflow..."
airflow db init

# CrÃ©er l'utilisateur admin
echo "ğŸ‘¤ CrÃ©ation de l'utilisateur admin..."
airflow users create \
    --username admin \
    --firstname TechShop \
    --lastname Admin \
    --role Admin \
    --email admin@techshop.com \
    --password admin123 \
    --quiet

# CrÃ©er le dossier des DAGs
echo "ğŸ“ CrÃ©ation du dossier DAGs..."
mkdir -p ~/airflow/dags

echo ""
echo "âœ… Installation terminÃ©e avec succÃ¨s !"
echo ""
echo "ğŸ¯ Prochaines Ã©tapes :"
echo "1. Copier les DAGs : cp dags/*.py ~/airflow/dags/"
echo "2. Lancer Airflow : bash start_airflow.sh"
echo "3. Interface web : http://localhost:8080"
echo "4. Login : admin / admin123"
